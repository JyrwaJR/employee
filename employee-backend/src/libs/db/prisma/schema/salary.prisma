// ==========================================
// Enums
// ==========================================

enum UserRole {
  ADMIN // Can manage salaries and employees
  HR // Can view and edit profiles
  EMPLOYEE // Read-only access to own data
}

enum EmploymentStatus {
  ACTIVE
  PROBATION
  SUSPENDED
  TERMINATED
  RESIGNED
  RETIRED
  DECEASED
}

enum PaymentStatus {
  PENDING // Generated but not approved
  PROCESSED // Sent to bank
  PAID // Confirmed
  FAILED // Bank reject
  HELD // Administrative hold
}

enum RevisionType {
  JOINING
  ANNUAL_INCREMENT // July/Jan standard increment
  MACP // Modified Assured Career Progression
  PROMOTION // Functional promotion
  DA_HIKE // Dearness Allowance adjustment
  PAY_COMMISSION // e.g., 7th to 8th CPC
  CORRECTION // Fix clerical error
}

enum Month {
  JANUARY
  FEBRUARY
  MARCH
  APRIL
  MAY
  JUNE
  JULY
  AUGUST
  SEPTEMBER
  OCTOBER
  NOVEMBER
  DECEMBER
}

enum CityClass {
  X // Metro (High HRA)
  Y // Urban
  Z // Rural
}

// ==========================================
// 1. Auth & User Management
// ==========================================

model UserSession {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         UserRole @default(EMPLOYEE)
  isActive     Boolean  @default(true)

  // Security
  refreshToken String?   @db.Text
  lastLoginAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation: 1-to-1 with Employee Profile
  employeeProfile EmployeeProfile?

  @@map("users")
}

// ==========================================
// 2. Employee Profile (Govt Specifics)
// ==========================================

model EmployeeProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Official Service Details
  empId          String    @unique // e.g. "GOV-2026-8821"
  designation    String // e.g. "Senior Technical Officer"
  department     String // e.g. "Ministry of Electronics & IT"
  officeLocation String // e.g. "CGO Complex, New Delhi"
  cityClass      CityClass @default(X) // Determines HRA %

  // 7th Pay Commission Matrix Position
  payLevel      Int // e.g. 10
  payCell       Int // e.g. 1
  dateOfJoining DateTime
  status        EmploymentStatus @default(ACTIVE)

  // Identifiers & Banking
  panNumber     String?
  pranNumber    String? // NPS Account Number (Mandatory for Govt)
  cghsCardNo    String? // Central Govt Health Scheme ID
  uanNumber     String? // Universal Account Number (if applicable)
  bankAccountNo String?
  bankIfsc      String?

  // Relations
  currentStructure SalaryStructure? // The settings for NEXT month
  salarySlips      SalarySlip[] // The history of PAST months
  revisions        SalaryRevision[] // History of increments/promotions
  leaves           LeaveRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employee_profiles")
}

// ==========================================
// 3. Salary Configuration (Current Settings)
// ==========================================

// Defines the CURRENT active breakdown for the employee.
// Used by the payroll generator to calculate the next month's slip.
model SalaryStructure {
  id         String          @id @default(cuid())
  employeeId String          @unique
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  // Earnings Config
  basicPay       Decimal  @default(0) @db.Decimal(10, 2)
  daRate         Decimal  @default(50.00) @db.Decimal(5, 2) // Current DA % (e.g. 50%)
  hraFixed       Decimal? @db.Decimal(10, 2) // Overrides % if set
  transportAllow Decimal  @default(0) @db.Decimal(10, 2)
  npa            Decimal  @default(0) @db.Decimal(10, 2) // Non-Practicing Allowance

  // Deductions Config
  isNpsActive    Boolean @default(true) // If true, auto-calc 10%
  cghsTierAmount Decimal @default(650) @db.Decimal(10, 2) // Fixed based on Pay Level
  cgegisAmount   Decimal @default(60) @db.Decimal(10, 2) // Group Insurance
  licenseFee     Decimal @default(0) @db.Decimal(10, 2) // Govt Quarter Fee

  effectiveDate DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@map("salary_structures")
}

// ==========================================
// 4. Monthly Salary Slip (Immutable Record)
// ==========================================

// The actual finalized payslip data for a specific month.
model SalarySlip {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  month       Month
  year        Int
  status      PaymentStatus @default(PENDING)
  paymentDate DateTime?

  // --- EARNINGS ---
  basicPay Decimal @db.Decimal(10, 2)
  da       Decimal @db.Decimal(10, 2) // Dearness Allowance
  hra      Decimal @db.Decimal(10, 2) // House Rent Allowance

  transportAllow Decimal @db.Decimal(10, 2) // TA
  daOnTa         Decimal @db.Decimal(10, 2) // DA on TA component

  npa     Decimal @default(0) @db.Decimal(10, 2)
  sba     Decimal @default(0) @db.Decimal(10, 2) // Special Duty Allowance
  arrears Decimal @default(0) @db.Decimal(10, 2) // DA Arrears/Increment Arrears
  bonus   Decimal @default(0) @db.Decimal(10, 2) // Diwali Bonus etc.

  totalEarnings Decimal @db.Decimal(10, 2)

  // --- DEDUCTIONS ---
  npsTier1   Decimal @db.Decimal(10, 2) // National Pension System
  cghs       Decimal @db.Decimal(10, 2)
  cgegis     Decimal @db.Decimal(10, 2)
  licenseFee Decimal @default(0) @db.Decimal(10, 2) // Govt Accommodation

  incomeTax Decimal @db.Decimal(10, 2) // TDS
  profTax   Decimal @db.Decimal(10, 2)
  gpf       Decimal @default(0) @db.Decimal(10, 2) // General Provident Fund (Old Pension)
  recovery  Decimal @default(0) @db.Decimal(10, 2) // Advance/Overpayment recovery

  totalDeductions Decimal @db.Decimal(10, 2)

  // --- FINAL ---
  netPayable Decimal @db.Decimal(10, 2)

  remarks     String? @db.Text // e.g. "Arrears for Jan-Mar paid"
  generatedBy String? // Admin ID

  createdAt DateTime @default(now())

  @@unique([employeeId, month, year]) // Prevent duplicate slips
  @@map("salary_slips")
}

// ==========================================
// 5. Revisions (Increment History)
// ==========================================

// Tracks history of Pay Level changes, MACP, or DA Hikes
model SalaryRevision {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  effectiveDate DateTime
  type          RevisionType

  // Track the Matrix Move
  prevPayLevel Int
  prevPayCell  Int
  prevBasic    Decimal @db.Decimal(10, 2)

  newPayLevel Int
  newPayCell  Int
  newBasic    Decimal @db.Decimal(10, 2)

  remarks    String? // e.g. "MACP Granted to Level 11 via Order No. 123"
  approvedBy String? // Admin ID

  createdAt DateTime @default(now())

  @@map("salary_revisions")
}

// ==========================================
// 6. Leave Management
// ==========================================

model LeaveRecord {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  type      String // EL (Earned Leave), CL (Casual), HPL (Half Pay)
  startDate DateTime
  endDate   DateTime
  daysCount Int

  reason String?
  status String  @default("PENDING") // APPROVED, REJECTED

  isLwp Boolean @default(false) // Leave Without Pay (Impacts SalarySlip)

  createdAt DateTime @default(now())

  @@map("leave_records")
}
